<style>
    @media screen and (max-width: 800px) 
    {
        .root 
        {
            grid-auto-rows: auto 0;
        }
    }
</style>

<div class="header cascaded">
    <div class="buttons">
        <button class="back" onclick="Topics.Back()"><$ topics back /></button>
        <button id="Button_NewProblem" class="icon" ad-tooltip="<$ topics tooltip_new_problem />">&#xf8dd;</button>
    </div>
    <div class="title hide"></div>
</div>

<div class="content">
    <h3 id="Text_TopicName"><#? topic.name ?#></h3>
    <div id="Grid_CourseProblems">
        <div class="progressring"></div>
    </div>
</div>

<div id="PopOver_Problem" class="popover" preventDefault>
    <div class="activity">
        <div class="header cascaded">
            <div class="buttons">
                <button id="Button_CancelNewProblem"><$ topics cancel /></button>
                <button id="Button_SubmitNewProblem">
                    <span><$ topics create /></span>
                    <div class="progressring"></div>
                </button>
            </div>
            <div class="title"><$ topics new_problem_title /></div>
        </div>
        <div class="content">
            <div class="list" ad-header="<$ topics source_header />">
                <div class="stack">
                    <span><$ topics type_label /></span>
                    <select class="plain" id="Select_ProblemSource"></select>
                </div>
                <div class="stack">
                    <span><$ topics academic_year_label /></span>
                    <input type="number" class="plain" min="2010" id="Input_ProblemYear" placeholder="<$ topics academic_year_placeholder />"/>
                </div>
            </div>
            <div class="pivot" id="Pivot_Problem">
                <div class="pivotcontent">
                    <div class="section">
                        <div class="pivottitle"><$ topics markdown_tab /></div>
                        <textarea id="Input_ProblemText" placeholder="<$ topics problem_text_placeholder />"></textarea>
                    </div>
                    <div class="section">
                        <div class="pivottitle"><$ topics preview_tab /></div>
                        <div class="preview" id="Grid_ProblemPreview"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="PopOver_EditProblem" class="popover" preventDefault>
    <div class="activity">
        <div class="header cascaded">
            <div class="buttons">
                <button id="Button_CancelEditProblem"><$ topics cancel /></button>
                <button id="Button_DoneEditProblem">
                    <span><$ topics save /></span>
                    <div class="progressring"></div>
                </button>
            </div>
            <div class="title"><$ topics edit_problem_title /></div>
        </div>
        <div class="content">
            <div class="list" ad-header="<$ topics source_header />">
                <div class="stack">
                    <span><$ topics type_label /></span>
                    <select class="plain" id="Select_ProblemSourceEdit"></select>
                </div>
                <div class="stack">
                    <span><$ topics academic_year_label /></span>
                    <input type="number" class="plain" min="2010" id="Input_ProblemYearEdit" placeholder="<$ topics academic_year_placeholder />"/>
                </div>
            </div>
            <div class="pivot" id="Pivot_ProblemEdit">
                <div class="pivotcontent">
                    <div class="section">
                        <div class="pivottitle"><$ topics markdown_tab /></div>
                        <textarea id="Input_ProblemTextEdit" placeholder="<$ topics problem_text_placeholder />"></textarea>
                    </div>
                    <div class="section">
                        <div class="pivottitle"><$ topics preview_tab /></div>
                        <div class="preview" id="Grid_ProblemPreviewEdit"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    {
        const a = Problems.Render;
        Problems.Render = async function(problem)
        {
            const box = await a(problem);
            box.oncontextmenu = function(event)
            {
                Components.ContextMenu.Open("Problem_Admin", box, event);
            }
            return box;
        }

        let typeTimeout;
        Input_ProblemText.oninput = function()
        {
            clearTimeout(typeTimeout);
            typeTimeout = setTimeout(async function()
            {
                Grid_ProblemPreview.innerHTML = await Problems.ParseMarkdownLatex(Input_ProblemText.value);
            }, 400);
        }
        Input_ProblemTextEdit.oninput = function()
        {
            clearTimeout(typeTimeout);
            typeTimeout = setTimeout(async function()
            {
                Grid_ProblemPreviewEdit.innerHTML = await Problems.ParseMarkdownLatex(Input_ProblemTextEdit.value);
            }, 400);
        }
        Input_ProblemText.onpaste = function()
        {
            const textarea = this;
            const items = event.clipboardData.items;

            for (let item of items) 
            {
                if (item.type.indexOf("image") !== -1) 
                {
                    const file = item.getAsFile();
                    const reader = new FileReader();

                    reader.onload = function (e) 
                    {
                        const base64 = e.target.result;
                        const markdownImage = `![pasted image](${base64})`;

                        const start = textarea.selectionStart;
                        const end = textarea.selectionEnd;

                        textarea.setRangeText(markdownImage, start, end, "end");
                        textarea.focus();
                        textarea.oninput();
                    };

                    reader.readAsDataURL(file);
                    event.preventDefault();
                }
            }
        }
        Input_ProblemTextEdit.onpaste = Input_ProblemText.onpaste;
        PopOver_Problem.onbeforeclose = function()
        {
            Components.ActionSheet.Open(
            {
                Title: "<$ topics discard_create_problem_title />",
                Description: "<$ topics discard_create_problem_desc />",
                Actions: [
                    { 
                        Title: "<$ topics discard />", Type: "Options.Critical", 
                        Action: o => 
                        {
                            PopOver_Problem.close(true);
                        }
                    },
                    { 
                        Title: "<$ topics keep_creating_problem />", Type: "Footer"
                    }
                ]
            }); 
        }
        PopOver_EditProblem.onbeforeclose = function()
        {
            Components.ActionSheet.Open(
            {
                Title: "<$ topics discard_edit_problem_title />",
                Description: "<$ topics discard_edit_problem_desc />",
                Actions: [
                    { 
                        Title: "<$ topics discard />", Type: "Options.Critical", 
                        Action: o => 
                        {
                            PopOver_EditProblem.close(true);
                        }
                    },
                    { 
                        Title: "<$ topics keep_editing_problem />", Type: "Footer"
                    }
                ]
            }); 
        }
        Button_NewProblem.onclick = function()
        {
            Pivot_Problem.tabs.selected = 0;
            Input_ProblemYear.value = "";
            Input_ProblemText.value = "";
            Grid_ProblemPreview.innerHTML = "";
            PopOver_Problem.open();
            Select_Fetch();
            Select_ProblemSource.value = Select_ProblemSource.options[0]?.value;
        }
        Button_SubmitNewProblem.onclick = function()
        {
            Button_SubmitNewProblem.disabled = true;
            Button_CancelNewProblem.disabled = true;
            PopOver_Problem.isloading = true;
            $("#PopOver_Problem :where(input, textarea, select)").attr("disabled", true);

            $.ajax(
            {
                type: "post",
                url: "/admin/problems/create",
                data: 
                {
                    question: Input_ProblemText.value,
                    source: Select_ProblemSource.value,
                    year: Input_ProblemYear.value,
                    topic: Topics.Active.id,
                    course: Topics.Active.course
                },
                success: async function(problem)
                {
                    const box = await Problems.Render(problem);
                    const group = Problems.AddToGroup(box, Grid_CourseProblems);

                    Button_SubmitNewProblem.disabled = false;
                    Button_CancelNewProblem.disabled = false;
                    PopOver_Problem.isloading = false;
                    PopOver_Problem.close(true);
                    $("#PopOver_Problem :where(input, textarea, select)").attr("disabled", false);

                    Problems.Sort(group);
                    Problems.Sort(Grid_CourseProblems);
                    UpdateTopicDetails();

                    Activity_Topic.scrollTop = box.offsetTop - 100;
                    
                    Components.Notification.Remove({ Id: "create_failed" });
                    Components.Notification.Send({ Id: "create_success", Title: "<$ topics create_success_title />", Message: "<$ topics create_success_message />", Icon: "\uef1c"});
                },
                error: function(error)
                {
                    Button_SubmitNewProblem.disabled = false;
                    Button_CancelNewProblem.disabled = false;
                    PopOver_Problem.isloading = false;
                    $("#PopOver_Problem :where(input, textarea, select)").attr("disabled", false);
                    Components.Notification.Send({ Id: "create_failed", Title: "<$ topics create_failed_title />", Message: error.responseText || "<$ topics error_generic />", Icon: "\ufe60", Buttons: [{Text: "<$ topics dismiss />"}] });
                }
            });
        }
        Button_CancelNewProblem.onclick = function()
        {
            PopOver_Problem.onbeforeclose();
        }
        Button_DoneEditProblem.onclick = function()
        {
            Button_DoneEditProblem.disabled = true;
            Button_CancelEditProblem.disabled = true;
            PopOver_EditProblem.isloading = true;
            $("#PopOver_EditProblem :where(input, textarea, select)").attr("disabled", true);

            const editedProblem =
            {
                id: PopOver_EditProblem.element.data.id,
                question: Input_ProblemTextEdit.value,
                source: {
                    id: Select_ProblemSourceEdit.value,
                    name: [...Select_ProblemSourceEdit.options].find(o => o.value == Select_ProblemSourceEdit.value)?.name
                },
                year: parseInt(Input_ProblemYearEdit.value),
                topic: Topics.Active.id,
                course: Topics.Active.course
            };

            $.ajax(
            {
                type: "patch",
                url: "/admin/problems/update",
                data: editedProblem,
                success: async function()
                {
                    Button_DoneEditProblem.disabled = false;
                    Button_CancelEditProblem.disabled = false;
                    PopOver_EditProblem.isloading = false;
                    PopOver_EditProblem.close(true);
                    $("#PopOver_EditProblem :where(input, textarea, select)").attr("disabled", false);
                    PopOver_EditProblem.element.data = editedProblem;
                    
                    const box = await Problems.Render(editedProblem);
                    const group = Problems.AddToGroup(PopOver_EditProblem.element, Grid_CourseProblems);
                    group.replaceChild(box, PopOver_EditProblem.element);

                    Problems.Sort(group);
                    Problems.Sort(Grid_CourseProblems);
                    UpdateTopicDetails();

                    Activity_Topic.scrollTop = box.offsetTop - 100;
                    
                    Components.Notification.Remove({ Id: "edit_failed" });
                    Components.Notification.Send({ Id: "edit_success", Title: "<$ topics edit_success_title />", Message: "<$ topics edit_success_message />", Icon: "\uef1c"});
                },
                error: function(error)
                {
                    Button_DoneEditProblem.disabled = false;
                    Button_CancelEditProblem.disabled = false;
                    PopOver_EditProblem.isloading = false;
                    $("#PopOver_EditProblem :where(input, textarea, select)").attr("disabled", false);
                    Components.Notification.Send({ Id: "edit_failed", Title: "<$ topics edit_failed_title />", Message: error.responseText || "<$ topics error_generic />", Icon: "\ufe60", Buttons: [{Text: "<$ topics dismiss />"}] });
                }
            });
        }
        Button_CancelEditProblem.onclick = function()
        {
            PopOver_EditProblem.onbeforeclose();
        }
        PopOver_Problem.onclosed = function()
        {
            Pivot_Problem.tabs.selected = 0;
        }
        PopOver_EditProblem.onclosed = function()
        {
            Pivot_ProblemEdit.tabs.selected = 0;
        }

        $.ajax(
        {
            type: "get",
            url: "/problems/get?id=<#? topic.id ?#>&type=topic",
            success: function(problems)
            {
                Grid_CourseProblems.innerHTML = "";
                Problems.Append(problems, Grid_CourseProblems);
            }
        });
    }
    async function UpdateTopicDetails()
    {
        const item = [...Grid_CourseTopics.children].find(o => o.data.id == Topics.Active.id);

        if (item == null)
            return;

        const topic = await $.get("/topics/get?id=" + item.data.id + "&type=topic");
        const box = Topics.Render(topic[0]);

        item.parentNode.replaceChild(box, item); 
    }
</script>