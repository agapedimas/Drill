<ad-title><#? topic.name ?#> - <#? course.name ?#> - <$ mentor title /></ad-title>
<ad-name><#? topic.name ?#> - <#? course.name ?#> | <$ mentor title /> | <#? apptitle ?#></ad-name>
<ad-desc>&#32;</ad-desc>

<style>
    @import url("/<#? applang ?#>/quiz.css");
    #Activity_Main
    {
        background: inherit;
    }
</style>

<div class="activity" id="Activity_QuizPanel">
    <div class="header cascaded">
        <div class="buttons">
            <button class="back" onclick="Quiz.Back()"><$ generic back /></button>
        </div>
    </div>
    <div class="content" id="Content_Panel">
        <div class="cards">
            <div class="detail">
                <span><$ generic topic /></span>
                <span><#? topic.name ?#></span>
                <button class="plain" id="Button_ChangeTopic"><$ topics change_title /></button>
            </div>
            <div class="detail">
                <span><$ generic course /></span>
                <span><#? course.name ?#></span>
            </div>
            <div class="detail hidden">
                <span><$ mentor metadata_updated /></span>
                <span id="Text_MetadataUpdated"></span>
            </div>
            <div class="detail hidden">
                <span><$ mentor metadata_score /></span>
                <span id="Text_MetadataScore"></span>
            </div>
        </div>
        <div class="cards">
            <div class="detail hidden">
                <span><$ generic problem /></span>
                <div id="Grid_ProblemNavigation"></div>
            </div>
        </div>
    </div>
    <script>Activity_Main.parentNode.prepend(Activity_QuizPanel);</script>
</div>

<section>
    <div class="header cascaded">
        <div class="title"><#? topic.name ?#></div>
        <div class="buttons">
            <button class="icon" id="Button_QuizPanel">&#xfaef;</button>
        </div>
    </div>

    <div class="content" id="Content_Quiz">
        <div id="Grid_Status" class="status">
            <div class="progressring"></div>
            <span id="Text_Status"></span>
        </div>
        <div id="Grid_QuizContainer">
            <div id="Text_Question" class="markdown"></div>
            <div id="Grid_Choices"></div>
        </div>
        <div id="Grid_QuizNavigation" class="hidden">
            <button id="Button_Prev" ad-tooltip="<$ generic prev />">
                <span class="icon">&#xef38;</span>
            </button>
            <button id="Button_Next" ad-tooltip="<$ generic next />">
                <span class="icon">&#xef4a;</span>
            </button>
            <div></div>
            <button id="Button_Submit" class="hidden">
                <span><$ generic submit/></span>
            </button>
        </div>
    </div>
</section>

<div class="popover" id="PopOver_Introduction">
    <h4><$ mentor welcome_title /></h4>
    <span><$ mentor welcome_description /></span>
    
    <div class="features">
        <div class="feature">
            <div class="icon">&#xed7e;</div>
            <div class="description">
                <b><$ mentor features_topic_title /></b>
                <span><$ mentor features_topic_description /></span>
            </div>
        </div>
        <div class="feature">
            <div class="icon">&#xfcd0;</div>
            <div class="description">
                <b><$ mentor features_problem_title /></b>
                <span><$ mentor features_problem_description /></span>
            </div>
        </div>
        <div class="feature">
            <div class="icon">&#xefc8;</div>
            <div class="description">
                <b><$ mentor features_update_title /></b>
                <span><$ mentor features_update_description /></span>
            </div>
        </div>
    </div>
    
    <div></div>
    
    <button class="accent" id="Button_Continue"><$ generic continue/></button>
</div>

<div class="popover" id="PopOver_SelectTopics">
    <div class="activity" id="Activity_SelectTopics">
        <section>
            <div class="header cascaded">
                <div class="buttons">
                    <button id="Button_Cancel"><$ generic cancel /></button>
                    <button class="icon" id="Button_Filter" ad-tooltip="<$ courses filter_title />">&#xf5bf;</button>
                </div>
                <div class="title"><$ topics change_title /></div>
            </div>
            <div class="content">
                <div id="Grid_Courses"></div>
            </div>
        </section>
        <section>
            <div class="header">
                <div class="title"></div>
            </div>
            <div class="content">
                <div id="Grid_CourseTopics"></div>
            </div>
        </section>
    </div>
</div>

<script src="/<#? applang ?#>/quiz.js"></script>
<script>
    if (localStorage.getItem("assistant_introduction") != "true")
    {
        window.onload = o => PopOver_Introduction.open();
        Button_Continue.onclick = o => PopOver_Introduction.close();
        localStorage.setItem("assistant_introduction", "true");
    }
    
    Button_ChangeTopic.onclick = function()
    {
        PopOver_SelectTopics.open();
    }

    function Status_Check()
    {
        return new Promise(function(resolve) 
        {
            $.ajax(
            {
                type: "get",
                url: "/topics/quiz/get/<#? topic.id ?#>",
                success: function(data)
                {
                    Quiz.Status = data.status;
                    Quiz.Problems = data.problems;
                    Quiz.Created = data.created;
    
                    if (data.status == "available")
                    {
                        const t1 = parseInt(Quiz.Created);
                        const t2 = new Date(Date.now() - Quiz.Created);
                        const time = t1 == 0 ? 0 : t2 > 1000 * 3600 * 24 * 6 ? moment(t1).format("ll") : moment(t1).fromNow();
                    
                        Grid_ProblemNavigation.innerHTML = null;
                        for (let i = 1; i <= Quiz.Problems.length; i++) {
                            const box = document.createElement("div");
                            box.classList.add("number");
                            box.append(i);
                            box.onclick = function() {
                                Quiz.Open(i - 1);
                            }
                            
                            Grid_ProblemNavigation.append(box);
                        }
    
                        Grid_ProblemNavigation.parentNode.classList.remove("hidden");
                        Text_MetadataUpdated.innerText = time;
                        Text_MetadataUpdated.parentNode.classList.remove("hidden");
                        Grid_Status.classList.add("hidden"); 
                        Grid_QuizNavigation.classList.remove("hidden");
                        
                        const lastSession = Data.Get("<#? topic.id ?#>");
                        if (lastSession?.value?.created == data.created && lastSession?.value?.result)
                        {
                            Button_Submit.classList.add("hidden");
                            const correct = lastSession.value.result.filter(o => o.isCorrect == true).length;
                            const total = lastSession.value.result.length;
                            Text_MetadataScore.innerText = Math.round(correct / total * 100);
                            Text_MetadataScore.parentNode.classList.remove("hidden");
                            Quiz.Problems = lastSession.value.result;
                            Quiz.Done = true;
    
                            for (let i = 0; i < Quiz.Problems.length; i++) {
                                if (Quiz.Problems[i].chosen && Quiz.Problems[i].chosen > -1)
                                    Grid_ProblemNavigation.children[i].classList.add("chosen");
                            }
                        }
                        else
                        {
                            Button_Submit.classList.remove("hidden");
                            Data.Set("<#? topic.id ?#>", 
                            { 
                                created: Quiz.Created,
                                result: null
                            });
                        }
                    
                        Quiz.Open(0);
                    }
                    else if (data.status == "generating")
                    {
                        Data.Set("<#? topic.id ?#>", 
                        { 
                            created: Quiz.Created,
                            result: null
                        });
    
                        Text_Status.innerText = "<$ mentor generating_message />";
                        setTimeout(Status_Check, 10000);
                    }
                    resolve();
                },
                error: resolve
            })
        });
    }
    Status_Check();

    Button_Prev.onclick = function()
    {
        Quiz.Open(Quiz.Active.Number - 1);
    }
    Button_Next.onclick = function()
    {
        Quiz.Open(Quiz.Active.Number + 1);
    }
    Button_Submit.onclick = async function()
    {
        Components.ActionSheet.Open(
        {
            Title: "<$ mentor answer_submit_title />",
            Description: "<$ mentor answer_submit_message />",
            Actions: [
                { 
                    Title: "<$ generic submit />", Type: "Options.Accent", 
                    Action: async function()
                    {
                        const result = await $.post("/topics/quiz/submit/<#? topic.id ?#>", { answers: Quiz.Problems.map(o => o.chosen) });
                        Data.Set("<#? topic.id ?#>", 
                        { 
                            created: Quiz.Created,
                            result: result
                        });

                        await Status_Check();
                    }
                },
                { 
                    Title: "<$ generic cancel />", Type: "Footer"
                }
            ]
        });
    }
    Button_QuizPanel.onclick = function() 
    {
        const main = Activity_Main.parentNode;
        if (main.classList.contains("opened")) 
        {
            main.classList.remove("opened");
        }
        else 
        {
            main.classList.add("opened");
            setTimeout(function(){
                Activity_Main.onclick = function()
                {
                    Activity_Main.onclick = null;
                    main.classList.remove("opened");
                }
            }, 500);
        }
    }
</script>